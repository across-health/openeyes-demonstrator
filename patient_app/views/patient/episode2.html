<script src="/javascripts/eyedraw.min.js" type="text/javascript"></script>
<!--<script type="text/javascript">-->



  <!--// Make variable accessible to button-->
  <!--var drawingEdit-->

  <!--// Runs on page load-->
  <!--function init()-->
  <!--{-->
    <!--// Create a drawing linked to the canvas-->
    <!--drawingEdit = new ED.Drawing(document.getElementById('canvasEdit'), ED.eye.Right, 'RPS', true, {graphicsPath:'/eyedraw/assets/img/'});-->

    <!--// Create a controller object for this drawing-->
    <!--var controller = new eyeDrawController(drawingEdit);-->

    <!--// Initialise drawing-->
    <!--drawingEdit.init();-->
  <!--}-->

  <!--// Controller class-->
  <!--function eyeDrawController(_drawing)-->
  <!--{-->
    <!--// Specify call back function-->
    <!--this.callBack = callBack;-->

    <!--// Register controller for notifications-->
    <!--_drawing.registerForNotifications(this, 'callBack', ['ready']);-->

    <!--// Show doodle controls-->
    <!--_drawing.showDoodleControls = true;-->

    <!--// Method called for notification-->
    <!--function callBack(_messageArray)-->
    <!--{-->
      <!--switch (_messageArray['eventName'])-->
      <!--{-->
        <!--// Ready notification-->
        <!--case 'ready':-->
          <!--_drawing.addDoodle('AntSeg');-->
          <!--_drawing.addBindings({CorticalCataract:{grade:{id:'gradeSelect'}}});-->
          <!--_drawing.addDeleteValues({gradeSelect:'None'});-->
          <!--_drawing.deselectDoodles();-->
          <!--break;-->
      <!--}-->
    <!--}-->
  <!--}-->


<!--</script>-->
<script type="text/javascript">

  // RSS calculations
  var rssPupil = 1.0;
  var rssPXE = 1.0;
  var rssNuclear = 1.0;
  var rssCortical = 1.0;
  var rssPhakoDonesis = 1.0;
  var rssSurgeon = 1.0;

  // Variables assigned to each drawing on this page
  var drawingEdit;
  var drawingDisplay;

  // Runs on page load
  function init()
  {
    // Get reference to the drawingEdit canvas
    var canvasEdit = document.getElementById('canvasEdit');

    // Create a drawing
    drawingEdit = new ED.Drawing(canvasEdit, ED.eye.Right, 'RPS', true, 0, 0);

    // Preload images
    drawingEdit.preLoadImagesFrom('/eyedraw/assets/img/patterns/');

    // Set focus to canvasEdit element
    canvasEdit.focus();

    // Wait for drawingEdit object to be ready before adding objects or drawingEdits
    drawingEdit.onLoaded = function()
    {
      drawingEdit.addDoodle('AntSeg');
      drawingEdit.deselectDoodles();
      drawingEdit.repaint();
    }

    // Get reference to the drawingDisplay canvas
    var canvasDisplay = document.getElementById('canvasDisplay');

    // Create blank drawing
    drawingDisplay = new ED.Drawing(canvasDisplay, ED.eye.Right, 'RPS', false);

    // Preload any images
    drawingDisplay.preLoadImagesFrom('/eyedraw/assets/img/patterns/');

    drawingDisplay.onLoaded = function()
    {
      drawingDisplay.addDoodle('AntSeg');
      drawingDisplay.addDoodle('NuclearCataract');
      drawingDisplay.addDoodle('Bleb');
      drawingDisplay.addDoodle('PI');
      drawingDisplay.deselectDoodles();
      drawingDisplay.repaint();
    }

    // Function to detect changes in parameters (eg from mouse dragging)
    drawingEdit.parameterListener = function()
    {
      var input;

      // Anterior segment (pupil)
      input = document.getElementById('pupil');

      // Check doodle of appropriate classname is selected
      if (drawingEdit.selectedDoodle != null && drawingEdit.selectedDoodle.className == 'AntSeg')
      {
        //input.value = drawingEdit.selectedDoodle.getGrade();
        input.value = drawingEdit.selectedDoodle.getParameter('grade');
      }

      // Nuclear cataract
      input = document.getElementById('nuclear');

      if (!drawingEdit.hasDoodleOfClass('NuclearCataract'))
      {
        input.value = 'None';
      }
      else
      {
        // Check doodle of appropriate classname is selected
        if (drawingEdit.selectedDoodle != null && drawingEdit.selectedDoodle.className == 'NuclearCataract')
        {
          //input.value = drawingEdit.selectedDoodle.getGrade();
          input.value = drawingEdit.selectedDoodle.getParameter('grade');
        }
      }

      // Cortical cataract
      input = document.getElementById('cortical');

      if (!drawingEdit.hasDoodleOfClass('CorticalCataract'))
      {
        input.value = 'None';
      }
      else
      {
        // Check doodle of appropriate classname is selected
        if (drawingEdit.selectedDoodle != null && drawingEdit.selectedDoodle.className == 'CorticalCataract')
        {
          //input.value = drawingEdit.selectedDoodle.getGrade();
          input.value = drawingEdit.selectedDoodle.getParameter('grade');
        }
      }
    }

  }

  /*
   function updateAntSeg(_value)
   {
   // Get reference to doodle
   var doodle = drawingEdit.firstDoodleOfClass('AntSeg');

   // Set grade
   doodle.setGrade(_value);

   drawingEdit.repaint();
   }
   */

  function updateNuclearCataract(_value)
  {
    if (_value == 'None')
    {
      drawingEdit.deleteDoodlesOfClass('NuclearCataract');
    }
    else
    {
      var doodle = drawingEdit.firstDoodleOfClass('NuclearCataract');
      if (!doodle)
      {
        var doodle = drawingEdit.addDoodle('NuclearCataract');
        drawingEdit.deselectDoodles();
      }

      // Set grade
      //doodle.setGrade(_value);
      doodle.setParameterWithAnimation('grade', _value);
    }
    drawingEdit.repaint();
  }

  function addToReport()
  {
    // Get text from the applet and force into string type
    var text = drawingEdit.report();

    // Use a RegEx to remove final comma and space
    text = text.replace(/, +$/, '');

    // Get reference to report textarea
    var repText = document.getElementById('antseg');

    // ***TEMP***
    repText.value = "";

    // If text there already, make it lower case and add a comma before
    if (repText.value.length > 0)
    {
      text = ", " + text.toLowerCase();
    }

    // Handle phacodonesis separately for now
    var input = document.getElementById('chk_phd');
    if (input.checked) text+= ", phacodonesis";

    // Add to existing text in text area
    repText.value += text;

    // Get reference to RRS score
    var rss = document.getElementById("RSS");

    // Pupil size
    input = document.getElementById('pupil');
    rssPupil = 1.0;
    if (input.value == 'Medium') rssPupil = 1.14;
    if (input.value == 'Small') rssPupil = 1.15;

    // PXE
    input = document.getElementById('chk_pxe');
    rssPXE = input.checked?2.92:1;

    // Nuclear
    input = document.getElementById('nuclear');
    rssNuclear = input.value == 'Brunescent'?2.99:1.0;

    // Cortical
    input = document.getElementById('cortical');
    rssCortical = input.value == 'White'?2.99:1.0;

    // Phakodonesis
    input = document.getElementById('chk_phd');
    rssPhakoDonesis = input.checked?2.92:1;

    // Surgeon
    input = document.getElementById('surgeon');
    rssSurgeon = +input.value;

    // Calculate total
    var CombinedOR = rssPupil * rssPXE * rssNuclear * rssCortical * rssPhakoDonesis * rssSurgeon;

    var p1 = 0.00736;
    var p = CombinedOR *(p1/(1-p1));
    var p2 = 100 * p/(1 + p);

    // Display updated value
    rss.innerHTML = p2.toFixed(2) + "%";
  }

  function togglePXE(_value)
  {
    var doodle = drawingEdit.firstDoodleOfClass('AntSeg');
    doodle.setParameter('pxe', _value);
    drawingEdit.repaint();
  }

  function updateCorticalCataract(_value)
  {
    if (_value == 'None')
    {
      drawingEdit.deleteDoodlesOfClass('CorticalCataract');
    }
    else
    {
      var doodle = drawingEdit.firstDoodleOfClass('CorticalCataract');
      if (!doodle)
      {
        var doodle = drawingEdit.addDoodle('CorticalCataract');
        drawingEdit.deselectDoodles();
      }

      // Set grade
      //doodle.setGrade(_value);
      doodle.setParameterWithAnimation('grade', _value);
    }
    drawingEdit.repaint();
  }

</script>


<div class="row panel callout radius">
  <div class="small-2 columns">
    {{episode.subSpecialty}}
  </div>
  <div class="small-4 columns">
    {{episode.startDate | date:'MMM dd, yyyy'}} -
    <span ng-show="episode.endDate != ''">{{episode.endDate | date:'MMM dd, yyyy'}}</span>
    <span ng-show="episode.endDate == ''"><em>outstanding</em></span>
  </div>
  <div class="small-2 columns">
    <span class="static-label">Eye: </span>{{episode.eye}}
  </div>
  <div class="small-4 columns">
    <span class="static-label">Diagnosis: </span>{{episode.diagnosis}}
  </div>
</div>
<div class="row">
  <div class="small-3 columns">
    <h4 class="section-header">Event list</h4>
    <div class="row episode-event" ng-repeat="event in episode.events">
      <div class="small-5 columns">
        <span class="label">{{event.type}}</span>
      </div>
      <div class="small-5 columns end">
        <span class="small-text">{{event.eventDate | date:'MMM dd, yyyy'}}</span>
      </div>
    </div>
  </div>
  <div class="small-9 columns">

    <h4 class="section-header">Event details</h4>
    <h5>Examination</h5>


    <script type="text/javascript">
      init();
    </script>


    <div style="width:800; float:left;">
      <h4>Edit mode:</h4>

      <!-- Drawing -->
      <div style="width:660px; float:left;">

        <!-- Doodle toolbar -->
        <div class="toolbar">
          <button class="ed-button" id="moveToFrontRPS" title="Move to front" onclick="drawingEdit.moveToFront(); return false;"><img src="../../graphics/moveToFront.gif"></button>
          <button class="ed-button" id="moveToBackRPS" title="Move to back" onclick="drawingEdit.moveToBack(); return false;"><img src="../../graphics//moveToBack.gif"></button>
          <button class="ed-button" id="deleteSelectedDoodleRPS" title="Delete" onclick="drawingEdit.deleteSelectedDoodle(); return false;"><img src="../../graphics/delete.gif"></button>
          <button class="ed-button" id="flipVerRPS" title="Flip around vertical axis" onclick="drawingEdit.flipVer(); return false;"><img src="../../graphics/flipVer.gif"></button>
          <button class="ed-button" id="flipHorRPS" title="Flip around horizontal axis" onclick="drawingEdit.flipHor(); return false;"><img src="../../graphics/flipHor.gif"></button>
          <button class="ed-button" id="lockRPS" title="Lock" onclick="drawingEdit.lock(); return false;"><img src="../../graphics//lock.gif"></button>
          <button class="ed-button" id="unlockRPS" title="Unlock" onclick="drawingEdit.unlock(); return false;"><img src="../../graphics/unlock.gif"></button>
          <br>

          <!-- Doodle selection toolbar -->
          <div class="toolbar">
            <button class="imgbutton" title="Freehand drawing" onclick="drawingEdit.addDoodle('Freehand'); return false;">
              <img src="../../graphics/Freehand.gif">
            </button>
            <button class="imgbutton" title="Label" onclick="drawingEdit.addDoodle('Label'); return false;">
              <img src="../../graphics/Label.gif">
            </button>
            <button class="imgbutton" title="Ciliary Injection" onclick="drawingEdit.addDoodle('CiliaryInjection'); return false;">
              <img src="../../graphics/CiliaryInjection.gif">
            </button>
            <button class="imgbutton" title="Corneal Oedema" onclick="drawingEdit.addDoodle('CornealOedema'); return false;">
              <img src="../../graphics/CornealOedema.gif">
            </button>
            <button class="imgbutton" title="Keratic Precipitates" onclick="drawingEdit.addDoodle('KeraticPrecipitates'); return false;">
              <img src="../../graphics/KeraticPrecipitates.gif">
            </button>
            <button class="imgbutton" title="PI" onclick="drawingEdit.addDoodle('PI'); return false;">
              <img src="../../graphics/PI.gif">
            </button>
            <button class="imgbutton" title="Rubeosis" onclick="drawingEdit.addDoodle('Rubeosis'); return false;">
              <img src="../../graphics/Rubeosis.gif">
            </button>
            <button class="imgbutton" title="Posterior Synechia" onclick="drawingEdit.addDoodle('PosteriorSynechia'); return false;">
              <img src="../../graphics/PosteriorSynechia.gif">
            </button>
            <button class="imgbutton" title="Busacca Nodule" onclick="drawingEdit.addDoodle('BusaccaNodule'); return false;">
              <img src="../../graphics/BusaccaNodule.gif">
            </button>
            <button class="imgbutton" title="Koeppe Nodule" onclick="drawingEdit.addDoodle('KoeppeNodule'); return false;">
              <img src="../../graphics/KoeppeNodule.gif">
            </button>
            <button class="imgbutton" title="Hyphaema" onclick="drawingEdit.addDoodle('Hyphaema'); return false;">
              <img src="../../graphics/Hyphaema.gif">
            </button>
            <button class="imgbutton" title="Hypopyon" onclick="drawingEdit.addDoodle('Hypopyon'); return false;">
              <img src="../../graphics/Hypopyon.gif">
            </button>
          </div>

          <br>
        </div>

        <!-- Canvas -->
        <div style="position:relative;">
          <span id="canvasTooltip"></span>
          <canvas id="canvasEdit" class="ed-canvas" width="300" height="300" tabindex="1"></canvas>
          <!-- Doodle control panel -->
          <div id="canvasEdit_controls" class="ed-doodle-popup" style="background-color: #DAE6F1; float:left; position:absolute; top:20px; left:310px;"><div><label for="canvasEdit_intensity_control">Intensity</label><select id="canvasEdit_intensity_control"><option>Mild</option><option>Moderate</option><option>Severe</option></select></div><div><label for="canvasEdit_epithelial_control">Epithelial</label><input type="checkbox" id="canvasEdit_epithelial_control" checked="checked"></div><div><label for="canvasEdit_stromal_control">Stromal</label><input type="checkbox" id="canvasEdit_stromal_control" checked="checked"></div><div><label for="canvasEdit_endothelial_control">Endothelial</label><input type="checkbox" id="canvasEdit_endothelial_control" checked="checked"></div></div>
        </div>

      </div>

      <!-- Controls -->
      <div style="width:240px; float:left;">

        <!-- Controls -->
        <div style="float:right; width: 300px;height: 320px;">
          <p class="lable">Description:</p>
          <p id="report" style="color: #0000FF;">Coloboma at 4 o'clock, pseudoexfoliation, corneal oedema, koeppe nodules</p>
          <p class="lable">Comments:</p>
          <textarea rows="5"></textarea>
          <!-- <input type="text" id="incisionMeridian" value='90'>; -->
        </div>
      </div>

    </div>

  </div>
</div>
